---
# Task to create a single Proxmox VM template
# Used by create_templates.yml playbook

- name: Destroy existing VMs for {{ template_name }}
  shell: |
    qm destroy {{ vmid }} 2>/dev/null || true
    qm destroy {{ vmid_custom }} 2>/dev/null || true

- name: Download image for {{ template_name }}
  get_url:
    url: "{{ image_url }}"
    dest: "{{ workingdir }}/{{ image_filename }}"
    mode: '0644'
  register: download_result
  retries: 3
  delay: 10
  until: download_result is succeeded

- name: Install virt-customize tools for {{ template_name }}
  package:
    name:
      - libguestfs-tools
    state: present
  become: yes

- name: Customize image with bash-completion for {{ template_name }}
  shell: |
    virt-customize -a {{ workingdir }}/{{ image_filename }} --install bash-completion 2>/dev/null || true
  register: virt_customize_bash
  changed_when: false
  failed_when: false

- name: Install qemu-guest-agent in image for {{ template_name }}
  shell: |
    virt-customize -a {{ workingdir }}/{{ image_filename }} --install qemu-guest-agent 2>/dev/null || true
  register: virt_customize_qemu
  changed_when: false
  failed_when: false

- name: Create Proxmox VM for {{ template_name }}
  shell: |
    qm create {{ vmid }} --name "{{ template_name }}" --ostype l26

- name: Configure VM network for {{ template_name }}
  shell: |
    qm set {{ vmid }} --net0 virtio,bridge=vmbr0

- name: Configure VM serial port for {{ template_name }}
  shell: |
    qm set {{ vmid }} --serial0 socket --vga serial0

- name: Configure VM memory and CPU for {{ template_name }}
  shell: |
    qm set {{ vmid }} --memory 1024 --cores 4 --cpu host

- name: Import disk image for {{ template_name }}
  shell: |
    qm set {{ vmid }} --scsi0 {{ PROXMOX_STORAGE_POOL }}:0,import-from=/root/{{ workingdir }}/{{ image_filename }},discard=on

- name: Configure boot order for {{ template_name }}
  shell: |
    qm set {{ vmid }} --boot order=scsi0 --scsihw virtio-scsi-single

- name: Enable QEMU agent for {{ template_name }}
  shell: |
    qm set {{ vmid }} --agent enabled=1,fstrim_cloned_disks=1

- name: Add cloud-init drive for {{ template_name }}
  shell: |
    qm set {{ vmid }} --ide3 {{ PROXMOX_STORAGE_POOL }}:cloudinit

- name: Resize disk for {{ template_name }}
  shell: |
    qm disk resize {{ vmid }} scsi0 8G

- name: Convert VM to template - {{ template_name }}
  shell: |
    qm template {{ vmid }}
  register: template_result

- name: Display template creation result for {{ template_name }}
  debug:
    msg: "Successfully created {{ template_name }} (VMID: {{ vmid }})"
